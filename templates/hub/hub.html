{% load static %}
<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Hub Administrativo</title>

  <!-- ======= ESTILOS CSS INTERNOS ======= -->
  <style>
    /* Reseta e estrutura básica */
    * {
      box-sizing: border-box;
    }

    /* Corpo da página */
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      display: flex;
      height: 100vh;
      overflow: hidden;
    }

    /* ======= MENU LATERAL (SIDEBAR) ======= */
    /* === MENU LATERAL (SIDEBAR) === */
    .sidebar {
      width: 240px;
      background-color: #2c3e50;
      color: white;
      padding: 20px;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }

    .sidebar h2 {
      text-align: center;
      font-size: 22px;
      margin-bottom: 20px;
      color: #ecf0f1;
    }

    /* Grupo de Menu (Categoria) */
    .menu-group {
      margin-bottom: 10px;
    }

    /* Botão de Categoria (colapsável) */
    .menu-toggle {
      background: none;
      border: none;
      color: #ecf0f1;
      font-size: 16px;
      font-weight: bold;
      padding: 10px 5px;
      width: 100%;
      text-align: left;
      cursor: pointer;
      position: relative;
      transition: background 0.3s;
    }

    .menu-toggle:hover {
      background-color: #34495e;
      border-radius: 4px;
    }

    /* Ícone de seta (rotate quando aberto) */
    .menu-toggle::after {
      content: "▸";
      position: absolute;
      right: 10px;
      transition: transform 0.3s;
    }

    .menu-toggle.active::after {
      transform: rotate(90deg);
    }

    /* Submenu interno */
    .menu-items {
      display: none;
      flex-direction: column;
      padding-left: 10px;
      border-left: 2px solid rgba(255, 255, 255, 0.1);
      margin-top: 5px;
    }

    /* Botões internos */
    .menu-items button {
      background: none;
      border: none;
      color: #bdc3c7;
      padding: 8px 10px;
      text-align: left;
      cursor: pointer;
      font-size: 14px;
      border-radius: 4px;
      transition: background 0.3s, color 0.3s;
    }

    .menu-items button:hover {
      background: #3d566e;
      color: #ffffff;
    }

    /* Botão de logout */
    .sidebar button.logout {
      background-color: #e74c3c;
      color: white;
      margin-top: auto;
      padding: 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      font-size: 15px;
    }

    .sidebar button.logout:hover {
      background-color: #c0392b;
    }


    /* ======= ÁREA PRINCIPAL DAS ABAS ======= */
    .main {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      background: #ecf0f1;
      overflow: hidden;
      height: 100vh;
      min-width: 0;
      /* Importante para evitar quebra */
    }

    #tabsContainer {
      flex-grow: 1;
      position: relative;
      overflow: auto;
      min-height: 0;
      background: #ffffff;
    }


    .tabs-header {
      display: flex;
      gap: 5px;
      padding: 10px;
      overflow-x: auto;
      background: #bdc3c7;
      border-bottom: 1px solid #999;
    }

    .tabs-header button {
      background: #95a5a6;
      border: none;
      padding: 10px 20px;
      border-radius: 5px 5px 0 0;
      cursor: pointer;
      position: relative;
      font-size: 14px;
      white-space: nowrap;
    }

    .tabs-header button.active {
      background: #ffffff;
      font-weight: bold;
    }

    .close-tab {
      position: absolute;
      top: 3px;
      right: 6px;
      color: red;
      font-weight: bold;
      cursor: pointer;
    }

    .tab {
      display: none;
      padding: 30px;
      background: #ffffff;
      height: 100%;
      overflow-y: auto;
    }

    .tab.active {
      display: block;
    }

    /* ======= FORMULÁRIOS ======= */
    form {
      margin-top: 10px;
    }

    form label {
      display: block;
      margin-top: 10px;
      font-weight: 500;
    }

    form input,
    form select,
    form textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      margin-top: 4px;
      font-size: 14px;
    }

    form button {
      margin-top: 20px;
      background: #2ecc71;
      color: white;
      padding: 10px 16px;
      border: none;
      border-radius: 5px;
      font-size: 15px;
      cursor: pointer;
    }

    form button:hover {
      background: #27ae60;
    }

    /* ======= TABELAS ======= */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      background: white;
    }

    table th,
    table td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }

    table th {
      background: #f5f5f5;
    }

    table tbody tr:hover {
      background-color: #f0f8ff;
    }

    /* ======= BOTÕES DE AÇÃO ======= */
    .btn-edit,
    .btn-delete {
      padding: 4px 8px;
      border: none;
      border-radius: 4px;
      color: white;
      cursor: pointer;
    }

    .btn-edit {
      background-color: #3498db;
    }

    .btn-delete {
      background-color: #e74c3c;
    }

    .btn-refresh {
      background-color: #27ae60;
      color: white;
      padding: 8px 14px;
      margin-bottom: 10px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
    }

    .form-grid-full {
      grid-column: 1 / -1;
    }

    tr.destacado {
      background-color: #fff9c4 !important;
      font-weight: bold;
    }

    .menu-group {
      margin-bottom: 10px;
    }

    .menu-toggle {
      background: #1a252f;
      color: white;
      padding: 10px;
      width: 100%;
      border: none;
      text-align: left;
      font-weight: bold;
      cursor: pointer;
      border-radius: 4px;
    }

    .menu-toggle:hover {
      background: #233140;
    }

    .menu-items {
      display: none;
      flex-direction: column;
      margin-top: 5px;
    }

    .menu-items button {
      background: #34495e;
      padding-left: 30px;
      font-size: 14px;
    }

    .card-container {
      display: flex;
      flex-wrap: wrap;
      gap: 40px 20px;
      /* 40px vertical, 20px horizontal */
      margin-top: 30px;
      justify-content: flex-start;
    }

    .financeiro-card {
      background-color: #ffffff;
      border: 1px solid #ddd;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      padding: 15px;
      width: 300px;
      transition: transform 0.2s ease;
      font-family: 'Segoe UI', sans-serif;
    }

    .financeiro-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
    }

    .financeiro-card strong {
      font-size: 18px;
      color: #2c3e50;
    }

    .financeiro-card b {
      display: inline-block;
      margin-top: 5px;
      color: #34495e;
    }

    .filtros-financeiro {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 20px;
      align-items: end;
    }

    .filtro {
      display: flex;
      flex-direction: column;
      min-width: 180px;
    }

    .filtro label {
      font-weight: 500;
      margin-bottom: 5px;
    }

    .filtro input,
    .filtro select {
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
    }

    .financeiro-tabela {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }

    .financeiro-tabela th,
    .financeiro-tabela td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }

    .financeiro-totais {
      margin-top: 20px;
      font-size: 1rem;
    }

    .resumo-financeiro {
      margin-bottom: 20px;
      font-size: 16px;
    }

    .resumo-financeiro p {
      margin: 4px 0;
    }

    /* empurra o que vem depois para baixo */
    .sidebar-spacer {
      flex-grow: 1;
    }

.sidebar { position: relative; }

.sidebar button.admin-panel {
  position: absolute;
  left: 20px;
  right: 20px;
  bottom: 56px;   /* ajuste para ficar acima do botão Sair */
  background-color: #777a7a;
  color: #fff;
  padding: 10px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-weight: bold;
  font-size: 15px;
  margin-bottom: 10px;
}
.sidebar button.admin-panel:hover { background-color: #6c3483; }

  </style>
</head>

<body>
  <!-- ==================== MENU LATERAL ==================== -->
  <div class="sidebar">
    <h2>Admin</h2>

    <div class="menu-group">
      <button class="menu-toggle">Cadastro</button>
      <div class="menu-items">
        <button onclick="openTab('cadastro', 'Cadastro de Cliente')">Cliente</button>
        <button onclick="openTab('cadastroUser', 'Cadastro Usuário')">Usuário</button>
      </div>
    </div>

    <div class="menu-group">
      <button class="menu-toggle">Rotinas</button>
      <div class="menu-items">
        <button onclick="openTab('controleOS', 'Controle OS')">Controle OS</button>
        <button onclick="openTab('financeiro', 'Financeiro')">Financeiro</button>
      </div>
    </div>

    <div class="menu-group">
      <button class="menu-toggle">Consultar</button>
      <div class="menu-items">
        <button onclick="openTab('listarClientes', 'Listar Clientes')">Clientes</button>
        <button onclick="openTab('listarUsuarios', 'Listar Usuários')">Usuários</button>
        <button onclick="openTab('listarOS', 'Listar OS')">Listar OS</button>
        <button onclick="openTab('consultar_financeiro', 'Consultar Financeiro')">Consulta Financeiro</button>
        <button onclick="openTab('fatura', 'Fatura')">Fatura</button>
      </div>
    </div>
    <div class="sidebar-spacer"></div>

    <button class="admin-panel" type="button" onclick="window.open('https://iproject-1.onrender.com/admin', '_blank')">
      Painel Administrador
    </button>


    <button class="logout" onclick="window.location.href='/logout/'">Sair</button>
  </div>

  <!-- ==================== ÁREA PRINCIPAL DAS ABAS ==================== -->
  <div class="main">
    <div class="tabs-header" id="tabsHeader"></div>
    <div id="tabsContainer" style="flex-grow: 1;">
      <div id="tab-home" class="tab active"
        style="display: flex; justify-content: center; align-items: center; height: 100%;">
        <img src="{% static 'imagens/logo1.jpg' %}" alt="Logo do Sistema"
          style="width: 100%; max-width: 1000px; height: auto;" />

      </div>
    </div>

  </div>
  <!-- ==================== SCRIPT PRINCIPAL DA INTERFACE ==================== -->
  <script>
    // Armazena todas as abas abertas
    const tabs = {};

    // ==================== FUNÇÃO PARA ABRIR ABAS ====================
    function openTab(id, title) {
      if (tabs[id]) {
        activateTab(id); // Se já existe, apenas ativa
        return;
      }

      // Cria botão da aba
      const header = document.createElement("button");
      header.textContent = title;
      header.className = "active";
      header.onclick = () => activateTab(id);

      // Botão de fechar aba
      const close = document.createElement("span");
      close.textContent = "×";
      close.className = "close-tab";
      close.onclick = (e) => {
        e.stopPropagation();
        document.getElementById("tabsHeader").removeChild(header);
        document.getElementById("tabsContainer").removeChild(tabs[id]);
        delete tabs[id];
        const remaining = Object.keys(tabs);
        if (remaining.length) activateTab(remaining[remaining.length - 1]);
      };

      header.appendChild(close);
      document.getElementById("tabsHeader").appendChild(header);

      // Cria conteúdo da aba
      const content = document.createElement("div");
      content.className = "tab active";
      content.id = "tab-" + id;

      // Remove a aba inicial com a logo, se estiver visível
      const homeTab = document.getElementById("tab-home");
      if (homeTab) homeTab.remove();


      // ==================== MÓDULO: CADASTRO DE CLIENTE ====================
      if (id === "cadastro") {
        content.innerHTML = `<h2>${title}</h2>
      <form id="clienteForm" method="POST" action="/cadastro/cadastrar/">{% csrf_token %}
        <div class="form-grid">
          <div><label>CNPJ/CPF:</label><input type="text" name="cpf_cnpj" required></div>
          <div><label>Razão Social:</label><input type="text" name="razao_social" required></div>
          <div><label>Tipo:</label>
            <select name="tipo" required>
              <option value="">Selecione...</option>
              <option value="Física">Física</option>
              <option value="Jurídica">Jurídica</option>
            </select>
          </div>
          <div><label>Modalidade:</label>
            <select name="modalidade" required>
              <option value="">Selecione...</option>
              <option value="Contrato">Contrato</option>
              <option value="Hora">Hora</option>
              <option value="Projeto">Projeto</option>
            </select>
          </div>
          <div class="form-grid-full"><label>Endereço:</label><textarea name="endereco" required></textarea></div>
          <div><label>Valor Cobrança (R$):</label><input type="number" name="valor_cobranca" step="0.01" required></div>
          <div><label>Data Faturamento:</label><input type="date" name="data_faturamento" required></div>
          <div>
  <label>Dia de Vencimento:</label>
  <input type="number" name="vencimento_dia" min="1" max="31" required>
</div>
        </div>
        <button type="submit">Salvar Cliente</button>
      </form>
      <p id="msgCadastro" style="margin-top:10px;"></p>`;

        setTimeout(() => {
          const form = content.querySelector("#clienteForm");
          const msg = content.querySelector("#msgCadastro");
          form.addEventListener("submit", async function (e) {
            e.preventDefault();
            const formData = new FormData(form);
            const csrfToken = form.querySelector('[name=csrfmiddlewaretoken]').value;
            try {
              const response = await fetch(form.action, {
                method: "POST",
                headers: { "X-CSRFToken": csrfToken },
                body: formData
              });
              msg.style.color = response.ok ? "green" : "red";
              msg.textContent = response.ok ? "Cliente cadastrado com sucesso!" : "Erro ao cadastrar cliente.";
              if (response.ok) form.reset();
            } catch {
              msg.style.color = "red";
              msg.textContent = "Erro na comunicação com o servidor.";
            }
          });
        }, 10);

        // ==================== MÓDULO: LISTAR CLIENTES ====================
      } else if (id === "listarClientes") {
        content.innerHTML = `<h2>${title}</h2>
      <button class="btn-refresh" onclick="atualizarTabelaClientes()">Atualizar</button>
      <div id="tabelaClientes">${gerarTabelaClientes()}</div>`;
        // ==================== MÓDULO: CADASTRO DE OS ====================
      } else if (id === "controleOS") {
        content.innerHTML = `<h2>${title}</h2>
        <button onclick="carregarControleOS()" class="btn-refresh" style="margin-bottom: 10px;">
  Atualizar Página
</button>

<form id="formOS" method="POST" action="/controleOS/cadastrar/">{% csrf_token %}
  <div class="form-grid">
    <div><label>Executante:</label><input type="text" name="executante" value="Artur" required></div>
    <div><label>Cliente:</label>
      <select name="cliente_id" required>
        <option value="">Selecione...</option>
        {% for cliente in clientes %}
        <option value="{{ cliente.id }}">{{ cliente.razao_social }}</option>
        {% endfor %}
      </select>
    </div>
    <div><label>Solicitante:</label><input type="text" name="solicitante" required></div>
    
    <div><label>Data Solicitação:</label><input type="date" name="data_solicitacao" required></div>

    <div><label>Previsão:</label><input type="date" name="previsao" required></div>
    <div class="form-grid-full"><label>Problema/Motivo:</label><textarea name="problema" required></textarea></div>
    <div><label>Data/Hora Início:</label><input type="datetime-local" name="data_inicio"></div>
    <div><label>Data/Hora Final:</label><input type="datetime-local" name="data_final"></div>
    <div><label>Horas Consumidas:</label><input type="text" name="horas_consumidas" readonly></div>
    <div><label>Total a Faturar (R$):</label><input type="text" name="total_faturar" readonly></div>
    <div><label>Status:</label>
<select name="status" required>
  <option value="">Selecione...</option>
  <option value="nao_iniciado">Não Iniciado</option>
  <option value="em_andamento">Em Andamento</option>
  <option value="concluido">Concluído</option>
</select>

    </div>
    <div><label>Faturado?</label>
      <select name="faturado" required>
        <option value="False">Não</option>
        <option value="True">Sim</option>
      </select>
    </div>
    <div><label>Data Faturamento:</label><input type="date" name="data_faturamento"></div>
  </div>
  <button type="submit">Salvar OS</button>
</form>
<p id="msgOS" style="margin-top:10px;"></p>`;

        setTimeout(() => {
          const form = content.querySelector("#formOS");
          const msg = content.querySelector("#msgOS");

          const dataInicioInput = form.querySelector('[name="data_inicio"]');
          const dataFinalInput = form.querySelector('[name="data_final"]');
          const horasInput = form.querySelector('[name="horas_consumidas"]');
          const totalInput = form.querySelector('[name="total_faturar"]');
          const clienteSelect = form.querySelector('[name="cliente_id"]');

          async function calcularHorasEValor() {
            const inicioStr = dataInicioInput.value;
            const fimStr = dataFinalInput.value;

            if (!inicioStr || !fimStr || !clienteSelect.value) return;

            const inicio = new Date(inicioStr);
            const fim = new Date(fimStr);

            if (isNaN(inicio) || isNaN(fim)) return;

            const diffMs = fim - inicio;
            const horas = parseFloat((diffMs / 1000 / 60 / 60).toFixed(2));

            if (horas > 0) {
              horasInput.value = horas;

              try {
                const res = await fetch(`/controleOS/cliente/${clienteSelect.value}/valor/`);
                const data = await res.json();

                if (data.modalidade.toLowerCase() === "hora") {
                  const valor = parseFloat(data.valor_cobranca);
                  if (!isNaN(valor)) {
                    const total = (horas * valor).toFixed(2);
                    totalInput.value = total;
                  }
                } else {
                  totalInput.value = "0.00";
                }
              } catch (err) {
                console.error("Erro ao buscar cliente:", err);
                totalInput.value = "Erro";
              }
            }
          }

          dataInicioInput.addEventListener("change", calcularHorasEValor);
          dataFinalInput.addEventListener("change", calcularHorasEValor);
          clienteSelect.addEventListener("change", calcularHorasEValor);

          form.addEventListener("submit", async function (e) {
            e.preventDefault();
            const formData = new FormData(form);
            const csrfToken = form.querySelector('[name=csrfmiddlewaretoken]').value;
            try {
              const res = await fetch(form.action, {
                method: "POST",
                headers: { "X-CSRFToken": csrfToken },
                body: formData
              });
              msg.style.color = res.ok ? "green" : "red";
              msg.textContent = res.ok ? "OS cadastrada com sucesso!" : "Erro ao cadastrar OS.";
              if (res.ok) form.reset();
            } catch {
              msg.style.color = "red";
              msg.textContent = "Erro de comunicação.";
            }
          });
        }, 10);


        // ==================== MÓDULO: LISTAR OS ====================
      } else if (id === "listarOS") {
        content.innerHTML = `<h2>${title}</h2>
<div class="form-grid">
  <div>
    <label>Cliente (por nome):</label>
    <input type="text" id="filtroCliente" placeholder="Buscar por cliente..." oninput="atualizarTabelaOS()">
  </div>
  <div>
    <label>Status:</label>
    <select id="filtroStatus" onchange="atualizarTabelaOS()">
      <option value="">Todos</option>
      <option value="nao_iniciado">Não Iniciado</option>
      <option value="em_andamento">Em Andamento</option>
      <option value="concluido">Concluído</option>
    </select>
  </div>
  <div>
    <label>Faturado:</label>
    <select id="filtroFaturado" onchange="atualizarTabelaOS()">
      <option value="">Todos</option>
      <option value="True">Sim</option>
      <option value="False">Não</option>
    </select>
  </div>
</div>

<!-- REINSERINDO O BOTÃO: -->
<button class="btn-refresh" onclick="atualizarTabelaOS()" style="margin-top: 10px;">Atualizar Lista</button>

<div id="tabelaOS" style="margin-top: 15px;">Carregando OS...</div>>`;

        setTimeout(() => {
          atualizarTabelaOS();
        }, 10);

        // ==================== MÓDULO: CADASTRO DE USUÁRIO ====================
      } else if (id === "cadastroUser") {
        content.innerHTML = `<h2>${title}</h2>
      <form id="userForm" method="POST" action="/cadastroUser/cadastrar/">{% csrf_token %}
        <div class="form-grid">
          <div><label>Nome:</label><input type="text" name="nome" required></div>
          <div><label>Email:</label><input type="email" name="email" required></div>
          <div><label>Usuário:</label><input type="text" name="username" required></div>
          <div><label>Senha:</label><input type="password" name="senha" required></div>
          <div class="form-grid-full"><label><input type="checkbox" name="is_admin"> Administrador?</label></div>
        </div>
        <button type="submit">Cadastrar Usuário</button>
      </form>
      <p id="msgUser" style="margin-top:10px;"></p>`;

        setTimeout(() => {
          const form = content.querySelector("#userForm");
          const msg = content.querySelector("#msgUser");
          form.addEventListener("submit", async function (e) {
            e.preventDefault();
            const formData = new FormData(form);
            const csrfToken = form.querySelector('[name=csrfmiddlewaretoken]').value;
            try {
              const res = await fetch(form.action, {
                method: "POST",
                headers: { "X-CSRFToken": csrfToken },
                body: formData
              });
              msg.style.color = res.ok ? "green" : "red";
              msg.textContent = res.ok ? "Usuário cadastrado com sucesso!" : "Erro ao cadastrar.";
              if (res.ok) form.reset();
            } catch {
              msg.style.color = "red";
              msg.textContent = "Erro de comunicação.";
            }
          });
        }, 10);

        // ==================== MÓDULO: LISTAR USUÁRIOS ====================
      } else if (id === "listarUsuarios") {
        content.innerHTML = `<h2>${title}</h2>
  <button class="btn-refresh" onclick="atualizarTabelaUsuarios()">Atualizar</button>
  <div id="tabelaUsuarios">Carregando usuários...</div>`;

        setTimeout(() => {
          atualizarTabelaUsuarios();
        }, 10);
        // ==================== MÓDULO: EM CONSTRUÇÃO ====================
        // No openTab, logo após os módulos existentes...
      } else if (id === "financeiro") {
        content.innerHTML = `
    <h2>${title} (Rotinas)</h2>
    <form id="formFinanceiro" method="POST" action="/financeiro/cadastrar/">{% csrf_token %}
      <div class="form-grid">
        <div>
          <label>Tipo:</label>
          <select name="tipo" required>
            <option value="">Selecione...</option>
            <option value="Receita">Receita</option>
            <option value="Despesa">Despesa</option>
          </select>
        </div>
        <div>
          <label>Favorecido:</label>
          <select name="cliente" required>
            <option value="">Selecione...</option>
            {% for cliente in clientes %}
              <option value="{{ cliente.id }}">{{ cliente.razao_social }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label>Vencimento:</label>
          <input type="date" name="vencimento" required>
        </div>
        <div>
          <label>Valor (R$):</label>
          <input type="number" name="valor" step="0.01" required>
        </div>
        <div>
          <label>Data de Baixa:</label>
          <input type="date" name="data_baixa">
        </div>
        <div>
          <label for="codigo_barras">Código de Barras / Chave Pix:</label>
          <input type="text" id="codigo_barras" name="codigo_barras" placeholder="Digite o código ou chave Pix" />
        </div>
        <div class="form-grid-full">
          <label>Observação:</label>
          <textarea name="observacao"></textarea>
        </div>
      </div>
      <button type="submit">Salvar Lançamento</button>
    </form>
    <p id="msgFinanceiro" style="margin-top:10px;"></p>
    <hr>
  `;

        setTimeout(() => {
          const form = content.querySelector("#formFinanceiro");
          const msg = content.querySelector("#msgFinanceiro");
          form.addEventListener("submit", async function (e) {
            e.preventDefault();
            const formData = new FormData(form);
            const csrfToken = form.querySelector('[name=csrfmiddlewaretoken]').value;
            try {
              const res = await fetch(form.action, {
                method: "POST",
                headers: { "X-CSRFToken": csrfToken },
                body: formData
              });
              msg.style.color = res.ok ? "green" : "red";
              msg.textContent = res.ok ? "Lançamento cadastrado com sucesso!" : "Erro ao salvar.";
              if (res.ok) form.reset();
            } catch {
              msg.style.color = "red";
              msg.textContent = "Erro de comunicação com o servidor.";
            }
          });
        }, 10);

      } else if (id === "consultar_financeiro") {
        content.innerHTML = `
    <h2>${title} (Consulta Financeira)</h2>

    <div class="filtros-financeiro">
      <div class="filtro">
        <label for="periodoInicio">Período Inicial:</label>
        <input type="date" id="periodoInicio" />
      </div>
      <div class="filtro">
        <label for="periodoFim">Período Final:</label>
        <input type="date" id="periodoFim" />
      </div>
      <div class="filtro">
        <label for="filtroTipo">Tipo:</label>
        <select id="filtroTipo">
          <option value="">Todos</option>
          <option value="Receita">Receita</option>
          <option value="Despesa">Despesa</option>
        </select>
      </div>
      <div class="filtro">
        <label for="filtroSituacao">Situação:</label>
        <select id="filtroSituacao">
          <option value="todos">Todos</option>
          <option value="aberto">Em Aberto</option>
          <option value="baixado">Baixados</option>
        </select>
      </div>
      <div class="filtro">
        <button class="btn-refresh" onclick="consultarFinanceiro()">Consultar</button>
      </div>
    </div>

    <div id="resultadoFinanceiro" style="margin-top:20px;">Nenhuma consulta feita.</div>
  `;
      } else if (id === "fatura") {
        content.innerHTML = `
    <h2>${title}</h2>

    <div class="filtros-financeiro">
      <div class="filtro">
        <label>Cliente:</label>
        <select id="fatCliente">
          <option value="">Selecione...</option>
          {% for cliente in clientes %}
            <option value="{{ cliente.id }}">{{ cliente.razao_social }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="filtro">
        <label>Período Inicial:</label>
        <input type="date" id="fatInicio" />
      </div>
      <div class="filtro">
        <label>Período Final:</label>
        <input type="date" id="fatFim" />
      </div>

      <div class="filtro">
        <label>Faturado:</label>
        <select id="fatFaturado">
          <option value="">Todos</option>
          <option value="True">Sim</option>
          <option value="False">Não</option>
        </select>
      </div>

      <div class="filtro">
        <button class="btn-refresh" onclick="consultarFatura()">Consultar</button>
      </div>
    </div>

    <div id="resultadoFatura" style="margin-top:20px;">Nenhuma consulta feita.</div>
  `;
      }



      // Adiciona o conteúdo da aba e ativa
      document.getElementById("tabsContainer").appendChild(content);
      tabs[id] = content;
      activateTab(id);
    }

    // ==================== ATIVA ABA SELECIONADA ====================
    function activateTab(id) {
      // Remove "active" de todos os botões da aba superior (as abas abertas)
      document.querySelectorAll(".tabs-header button").forEach(btn => {
        btn.classList.remove("active");
      });

      // Remove "active" de todos os conteúdos das abas
      document.querySelectorAll(".tab").forEach(tab => {
        tab.classList.remove("active");
      });

      // Ativa somente a aba de conteúdo com o ID fornecido
      const abaConteudo = tabs[id];
      if (abaConteudo) {
        abaConteudo.classList.add("active");
      }

      // Ativa somente o botão da aba correspondente na barra de abas abertas
      const botoes = document.querySelectorAll(".tabs-header button");
      botoes.forEach(btn => {
        const texto = btn.textContent.replace("×", "").trim();  // Remove o X de fechar
        const tituloDaAba = abaConteudo.querySelector("h2")?.textContent.trim() || "";

        // Verifica se o texto do botão é igual ao título da aba (antes do parêntese)
        const tituloLimpo = tituloDaAba.split("(")[0].trim(); // Remove o " (Consulta Financeira)"
        if (texto === tituloLimpo) {
          btn.classList.add("active");
        }
      });
    }


    // ==================== GERAÇÃO DE TABELAS (renderizadas pelo Django) ====================
    function gerarTabelaClientes() {
      return `<table>
      <thead>
        <tr>
          <th>Razão Social</th>
          <th>CPF/CNPJ</th>
          <th>Tipo</th>
          <th>Modalidade</th>
          <th>Endereço</th>
          <th>Valor</th>
          <th>Faturamento</th>
          <th>Vencimento</th>
        </tr>
      </thead>
      <tbody>
        {% for cliente in clientes %}
        <tr>
          <td>{{ cliente.razao_social }}</td>
          <td>{{ cliente.cpf_cnpj }}</td>
          <td>{{ cliente.tipo }}</td>
          <td>{{ cliente.modalidade }}</td>
          <td>{{ cliente.endereco }}</td>
          <td>{{ cliente.valor_cobranca }}</td>
          <td>{{ cliente.data_faturamento|date:"d/m/Y" }}</td>
          <td>
  {% if cliente.vencimento_dia %}
    Dia {{ cliente.vencimento_dia }}
  {% else %}
    —
  {% endif %}
</td>

        </tr>
        {% endfor %}
      </tbody>
    </table>`;
    }

    function gerarTabelaOS() {
      return `<table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Executante</th>
          <th>Cliente</th>
          <th>Solicitante</th>
          <th>Solicitado em</th>
          <th>Problema</th>
          <th>Início</th>
          <th>Final</th>
        </tr>
      </thead>
      <tbody>
        {% for os in ordens %}
        <tr>
          <td>{{ os.id }}</td>
          <td>{{ os.executante }}</td>
          <td>{{ os.cliente.razao_social }}</td>
          <td>{{ os.solicitante }}</td>
          <td>{{ os.data_solicitacao}}</td>
          <td>{{ os.problema }}</td>
          <td>{{ os.data_inicio|date:"d/m/Y H:i" }}</td>
          <td>{{ os.data_final|date:"d/m/Y H:i" }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>`;
    }

    // ==================== ATUALIZAÇÃO DE TABELAS ====================
    function atualizarTabelaClientes() {
      const div = document.querySelector("#tabelaClientes");
      if (!div) return;

      fetch("/cadastro/listar/tabela/")
        .then(res => res.text())
        .then(html => {
          div.innerHTML = html;
          div.querySelectorAll(".form-excluir").forEach(form => {
            form.addEventListener("submit", function (e) {
              if (!confirm("Deseja realmente excluir este cliente?")) {
                e.preventDefault();
              }
            });
          });
        })
        .catch(() => {
          div.innerHTML = "<p style='color:red;'>Erro ao atualizar tabela de clientes.</p>";
        });
    }

    function atualizarTabelaUsuarios() {
      const div = document.querySelector("#tabelaUsuarios");
      if (!div) return;
      fetch("/cadastroUser/listar/tabela/")
        .then(res => res.text())
        .then(html => div.innerHTML = html)
        .catch(() => div.innerHTML = "<p style='color:red;'>Erro ao atualizar tabela de usuários.</p>");
    }

    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    function atualizarTabelaOS() {
      const div = document.querySelector("#tabelaOS");
      if (!div) return;

      const cliente = document.getElementById("filtroCliente")?.value || "";
      const status = document.getElementById("filtroStatus")?.value || "";
      const faturado = document.getElementById("filtroFaturado")?.value || "";

      const params = new URLSearchParams({ cliente, status, faturado });

      fetch(`/controleOS/listar/?${params.toString()}`)
        .then(res => res.text())
        .then(html => {
          div.innerHTML = html;

          div.querySelectorAll(".btn-edit").forEach(btn => {
            btn.addEventListener("click", function () {
              const row = this.closest("tr");
              row.querySelectorAll("[data-editable]").forEach(cell => {
                const field = cell.dataset.field;
                let value = cell.textContent.trim();

                if (value === "None" || value === "null") value = "";

                if (field === "status") {
                  cell.innerHTML = `
                <select data-input="${field}">
                  <option value="nao_iniciado" ${value === "Não Iniciado" ? "selected" : ""}>Não Iniciado</option>
                  <option value="em_andamento" ${value === "Em Andamento" ? "selected" : ""}>Em Andamento</option>
                  <option value="concluido" ${value === "Concluído" ? "selected" : ""}>Concluído</option>
                </select>`;
                } else if (field === "faturado") {
                  cell.innerHTML = `
                <select data-input="${field}">
                  <option value="False" ${value === "Não" ? "selected" : ""}>Não</option>
                  <option value="True" ${value === "Sim" ? "selected" : ""}>Sim</option>
                </select>`;
                } else if (field === "data_inicio" || field === "data_final") {
                  // Converte para datetime-local (só se tiver valor)
                  let formatted = "";
                  if (value) {
                    const dt = new Date(value);
                    if (!isNaN(dt)) {
                      formatted = dt.toISOString().slice(0, 16);
                    }
                  }
                  cell.innerHTML = `<input type="datetime-local" data-input="${field}" value="${formatted}" />`;
                } else {
                  cell.innerHTML = `<input data-input="${field}" value="${value}" />`;
                }
              });

              this.style.display = "none";
              row.querySelector(".btn-save").style.display = "inline-block";
            });
          });

          div.querySelectorAll(".btn-save").forEach(btn => {
            btn.addEventListener("click", function () {
              const row = this.closest("tr");
              const id = this.dataset.id;
              const formData = new FormData();

              row.querySelectorAll("[data-input]").forEach(input => {
                formData.append(input.dataset.input, input.value);
              });

              fetch(`/controleOS/editar/${id}/`, {
                method: "POST",
                headers: {
                  "X-CSRFToken": getCookie("csrftoken")
                },
                body: formData,
              }).then(res => {
                if (res.ok) {
                  atualizarTabelaOS();
                } else {
                  alert("Erro ao salvar.");
                }
              }).catch(() => {
                alert("Falha na comunicação com o servidor.");
              });
            });
          });
        })
        .catch(() => {
          div.innerHTML = "<p style='color:red;'>Erro ao carregar a tabela de OS.</p>";
        });
    }

    // Essa função já deve existir no seu código
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + "=")) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }



    function salvarEdicaoOS(id) {
      const row = document.querySelector(`tr[data-id="${id}"]`);
      const executante = row.querySelector('input[name="executante"]').value;
      const solicitante = row.querySelector('input[name="solicitante"]').value;
      const status = row.querySelector('select[name="status"]').value;

      fetch(`/controleOS/editar/${id}/`, {
        method: "POST",
        headers: {
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: new URLSearchParams({
          executante,
          solicitante,
          status
        })
      }).then(res => res.json())
        .then(data => {
          if (data.status === 'ok') alert("Salvo com sucesso!");
          else alert("Erro ao salvar: " + (data.error || 'desconhecido'));
        });
    }
    function carregarControleOS() {
      const id = "controleOS";
      const title = "Controle OS";

      // Remove a aba atual se ela existir
      if (tabs[id]) {
        const tabEl = tabs[id];
        const headerBtns = document.querySelectorAll(".tabs-header button");

        headerBtns.forEach(btn => {
          const span = btn.querySelector(".close-tab");
          if (span && btn.textContent.replace(span.textContent, '').trim() === title) {
            btn.remove();
          }
        });

        tabEl.remove();
        delete tabs[id];
      }

      // Cria botão de aba
      const header = document.createElement("button");
      header.textContent = title;
      header.className = "active";
      header.onclick = () => activateTab(id);

      const close = document.createElement("span");
      close.textContent = "×";
      close.className = "close-tab";
      close.onclick = (e) => {
        e.stopPropagation();
        document.getElementById("tabsHeader").removeChild(header);
        document.getElementById("tabsContainer").removeChild(tabs[id]);
        delete tabs[id];
        const remaining = Object.keys(tabs);
        if (remaining.length) activateTab(remaining[remaining.length - 1]);
      };

      header.appendChild(close);
      document.getElementById("tabsHeader").appendChild(header);

      const content = document.createElement("div");
      content.className = "tab active";
      content.id = "tab-" + id;
      document.getElementById("tabsContainer").appendChild(content);
      tabs[id] = content;

      // Carrega o HTML via fetch e inicializa JS
      fetch("/controleOS/formulario/")
        .then(res => res.text())
        .then(html => {
          content.innerHTML = html;
          activateTab(id);

          // 👇 Garante que o DOM esteja renderizado antes de inicializar os eventos
          setTimeout(() => {
            inicializarFormularioOS();
          }, 0);
        })
        .catch(() => {
          content.innerHTML = "<p style='color:red;'>Erro ao carregar formulário de OS.</p>";
        });
    }

    function inicializarFormularioOS() {
      const form = document.getElementById("formOS");
      if (!form) return;

      const msg = document.getElementById("msgOS");
      const dataInicioInput = form.querySelector('[name="data_inicio"]');
      const dataFinalInput = form.querySelector('[name="data_final"]');
      const horasInput = form.querySelector('[name="horas_consumidas"]');
      const totalInput = form.querySelector('[name="total_faturar"]');
      const clienteSelect = form.querySelector('[name="cliente_id"]');

      async function calcularHorasEValor() {
        const inicioStr = dataInicioInput.value;
        const fimStr = dataFinalInput.value;
        if (!inicioStr || !fimStr || !clienteSelect.value) return;

        const inicio = new Date(inicioStr);
        const fim = new Date(fimStr);
        const diffMs = fim - inicio;
        const horas = parseFloat((diffMs / 1000 / 60 / 60).toFixed(2));

        if (horas > 0) {
          horasInput.value = horas;
          try {
            const res = await fetch(`/controleOS/cliente/${clienteSelect.value}/valor/`);
            const data = await res.json();
            if (data.modalidade === "hora") {
              const valor = parseFloat(data.valor);
              if (!isNaN(valor)) {
                totalInput.value = (horas * valor).toFixed(2);
              }
            } else {
              totalInput.value = "0.00";
            }
          } catch {
            totalInput.value = "Erro";
          }
        }
      }

      dataInicioInput.addEventListener("change", calcularHorasEValor);
      dataFinalInput.addEventListener("change", calcularHorasEValor);
      clienteSelect.addEventListener("change", calcularHorasEValor);

      form.addEventListener("submit", async function (e) {
        e.preventDefault();
        const formData = new FormData(form);
        const csrfToken = form.querySelector('[name=csrfmiddlewaretoken]').value;

        try {
          const res = await fetch(form.action, {
            method: "POST",
            headers: { "X-CSRFToken": csrfToken },
            body: formData
          });

          msg.style.color = res.ok ? "green" : "red";
          msg.textContent = res.ok ? "OS cadastrada com sucesso!" : "Erro ao cadastrar OS.";
          if (res.ok) form.reset();
        } catch {
          msg.style.color = "red";
          msg.textContent = "Erro de comunicação.";
        }
      });
    }
    document.querySelectorAll(".menu-toggle").forEach(toggle => {
      toggle.addEventListener("click", () => {
        const items = toggle.nextElementSibling;
        const isOpen = items.style.display === "flex";

        // Fecha todos os outros menus
        document.querySelectorAll(".menu-items").forEach(el => el.style.display = "none");
        document.querySelectorAll(".menu-toggle").forEach(btn => btn.classList.remove("active"));

        // Abre ou fecha atual
        if (!isOpen) {
          items.style.display = "flex";
          toggle.classList.add("active");
        }
      });
    });


    function consultarFinanceiro() {
      const inicio = document.getElementById("periodoInicio").value;
      const fim = document.getElementById("periodoFim").value;
      const tipo = document.getElementById("filtroTipo").value;
      const situacao = document.getElementById("filtroSituacao").value;
      const resultadoDiv = document.getElementById("resultadoFinanceiro");
      resultadoDiv.innerHTML = "<p>Carregando...</p>";

      const params = new URLSearchParams({ inicio, fim, tipo, situacao });

      fetch(`/financeiro/consultar/?${params.toString()}`)
        .then(res => res.json())
        .then(data => {
          const resultados = data.resultados;

          if (resultados.length === 0) {
            resultadoDiv.innerHTML = "<p>Nenhum lançamento encontrado.</p>";
            return;
          }

          // ==== SOMATÓRIO DE VALORES ====
          let totalReceitas = 0;
          let totalDespesas = 0;

          resultados.forEach(item => {
            const valor = parseFloat(item.valor);
            if (item.tipo === "Receita") totalReceitas += valor;
            if (item.tipo === "Despesa") totalDespesas += valor;
          });

          const saldo = totalReceitas - totalDespesas;

          let totaisHTML = `
        <div class="resumo-financeiro">
          <p><strong>Total de Receitas:</strong> R$ ${totalReceitas.toFixed(2)}</p>
          <p><strong>Total de Despesas:</strong> R$ ${totalDespesas.toFixed(2)}</p>
          <p><strong>Saldo:</strong> R$ ${saldo.toFixed(2)}</p>
        </div>
      `;

          // ==== TABELA DE DADOS ====
          let tabela = `
        <table class="financeiro-tabela">
          <thead>
            <tr>
              <th>Tipo</th>
              <th>Cliente</th>
              <th>Valor (R$)</th>
              <th>Vencimento</th>
              <th>Data de Baixa</th>
              <th>Situação</th>
              <th>Código</th>
              <th>Observação</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody>
      `;

          resultados.forEach(item => {
            tabela += `
          <tr>
            <td>
              <select id="tipo-${item.id}">
                <option value="Receita" ${item.tipo === "Receita" ? "selected" : ""}>Receita</option>
                <option value="Despesa" ${item.tipo === "Despesa" ? "selected" : ""}>Despesa</option>
              </select>
            </td>
            <td>${item.cliente}</td>
            <td><input type="number" step="0.01" id="valor-${item.id}" value="${item.valor}"></td>
            <td><input type="date" id="vencimento-${item.id}" value="${item.vencimento}"></td>
            <td><input type="date" id="dataBaixa-${item.id}" value="${item.data_baixa}"></td>
            <td>${item.situacao}</td>
            <td>${item.codigo_barras}</td>
            <td>${item.observacao}</td>
            <td><button onclick="salvarEdicaoFinanceiro(${item.id})">Salvar</button></td>
          </tr>
        `;
          });

          tabela += "</tbody></table>";

          resultadoDiv.innerHTML = totaisHTML + tabela;
        })
        .catch(() => {
          resultadoDiv.innerHTML = "<p style='color:red;'>Erro ao consultar financeiro.</p>";
        });
    }

    // Função para salvar edição
    function salvarEdicaoFinanceiro(id) {
      const tipo = document.getElementById(`tipo-${id}`).value;
      const valor = document.getElementById(`valor-${id}`).value;
      const vencimento = document.getElementById(`vencimento-${id}`).value;
      const data_baixa = document.getElementById(`dataBaixa-${id}`).value;

      fetch(`/financeiro/editar/${id}/`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCSRFToken() // certifique-se que sua função CSRF está definida
        },
        body: JSON.stringify({ tipo, valor, vencimento, data_baixa })
      })
        .then(res => res.json())
        .then(data => {
          if (data.status === "sucesso") {
            alert("Atualizado com sucesso!");
            consultarFinanceiro(); // recarrega a tabela
          } else {
            alert("Erro: " + data.mensagem);
          }
        })
        .catch(() => {
          alert("Erro ao salvar alterações.");
        });
    }


    // Converte "dd/mm/yyyy" para "yyyy-mm-dd" para input date
    function formataParaInput(dataStr) {
      if (!dataStr || dataStr === "—") return "";
      const [dia, mes, ano] = dataStr.split("/");
      return `${ano}-${mes}-${dia}`;
    }

    // Captura o CSRF do cookie
    function getCSRFToken() {
      const name = "csrftoken";
      const cookies = document.cookie.split(";");
      for (const cookie of cookies) {
        const trimmed = cookie.trim();
        if (trimmed.startsWith(name + "=")) {
          return trimmed.slice(name.length + 1);
        }
      }
      return "";
    }


    function salvarBaixaFinanceiro(id, btn) {
      const card = btn.closest(".financeiro-card");
      const input = card.querySelector(`.input-baixa[data-id="${id}"]`);
      const novaData = input.value;
      const status = card.querySelector(".msg-status");

      fetch(`/financeiro/editar/${id}/`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCSRFToken(),
        },
        body: JSON.stringify({ data_baixa: novaData })
      })
        .then(res => {
          if (res.ok) {
            status.textContent = "✅ Salvo!";
            status.style.color = "green";
          } else {
            status.textContent = "Erro ao salvar";
            status.style.color = "red";
          }
        })
        .catch(() => {
          status.textContent = "Falha na requisição";
          status.style.color = "red";
        });
    }

    function getCSRFToken() {
      return document.cookie
        .split("; ")
        .find(row => row.startsWith("csrftoken="))
        ?.split("=")[1];
    }
    function consultarFatura() {
      const cliente = document.getElementById("fatCliente").value;
      const inicio = document.getElementById("fatInicio").value;
      const fim = document.getElementById("fatFim").value;
      const faturado = document.getElementById("fatFaturado").value; // "" | "True" | "False"
      const div = document.getElementById("resultadoFatura");
      if (!div) return;

      if (!cliente || !inicio || !fim) {
        div.innerHTML = "<p style='color:red;'>Selecione cliente, data inicial e data final.</p>";
        return;
      }

      div.innerHTML = "<p>Carregando...</p>";
      const params = new URLSearchParams({ cliente, inicio, fim, faturado, status: "concluido" });

      fetch(`/fatura/consultar/?${params.toString()}`)
        .then(res => res.json())
        .then(data => {
          console.log("DEBUG /fatura/consultar =>", data.debug);

          // <<< O array certo vem em data.os >>>
          const osList = Array.isArray(data.os) ? data.os : [];
          if (!osList.length) {
            div.innerHTML = "<p>Nenhuma OS concluída encontrada para o período/cliente.</p>";
            return;
          }

          const clienteObj = data.cliente || {};
          const periodo = data.periodo || { inicio, fim };
          const fFat = data.faturado;

          // Totais
          let somaHoras = 0, somaTotal = 0;
          osList.forEach(i => {
            somaHoras += parseFloat(i.horas || 0) || 0;
            somaTotal += parseFloat(i.total || 0) || 0;
          });

          const resumoHTML = `
        <div class="resumo-financeiro">
          <p><strong>Cliente:</strong> ${clienteObj.razao_social || "—"}</p>
          <p><strong>Período:</strong> ${formatarDataBR(periodo.inicio)} a ${formatarDataBR(periodo.fim)}</p>
          <p><strong>Status da Fatura:</strong> ${fFat === true
              ? "<span style='color:green; font-weight:bold;'>Fatura Fechada</span>"
              : fFat === false
                ? "<span style='color:#e67e22; font-weight:bold;'>Fatura em Aberto</span>"
                : "<span style='color:#7f8c8d; font-weight:bold;'>—</span>"
            }</p>
        </div>
      `;

          // Tabela
          let tabela = `
        <table class="financeiro-tabela">
          <thead>
            <tr>
              <th>ID</th>
              <th>Executante</th>
              <th>Solicitação</th>
              <th>Solicitado em</th>
              <th>Problema</th>
              <th>Início</th>
              <th>Fim</th>
              <th>Horas</th>
              <th>Total (R$)</th>
            </tr>
          </thead>
          <tbody>
      `;
          osList.forEach(it => {
            const h = parseFloat(it.horas || 0) || 0;
            const v = parseFloat(it.total || 0) || 0;
            tabela += `
          <tr>
            <td>${it.id}</td>
            <td>${it.executante || "—"}</td>
            <td>${it.solicitante || "—"}</td>
            <td>${formatarDataBR(it.data_solicitacao)}</td>
            <td>${it.problema || "—"}</td>
            <td>${formatarDataHoraBR(it.inicio)}</td>
            <td>${formatarDataHoraBR(it.fim)}</td>
            <td>${h.toFixed(2)}</td>
            <td>R$ ${v.toFixed(2)}</td>
          </tr>
        `;
          });
          tabela += `
          </tbody>
          <tfoot>
            <tr>
              <th colspan="7" style="text-align:right;">Totais:</th>
              <th>${somaHoras.toFixed(2)}</th>
              <th>R$ ${somaTotal.toFixed(2)}</th>
            </tr>
          </tfoot>
        </table>
      `;

          // Botões
          const botoes = `
        <div style="margin-top:15px; display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn-refresh" onclick='imprimirNota(${JSON.stringify({
            empresa: {
              nome: "ZETA TECNOLOGIA E CONSULTORIA LTDA",
              cnpj: "37.675.286/0004-15",
              logo: "{% static 'imagens/logo1.jpg' %}"
            },
            cliente: clienteObj,
            periodo,
            faturado: fFat,
            os: osList,
            totais: { horas: somaHoras.toFixed(2), valor: somaTotal.toFixed(2) }
          }).replace(/'/g, "&apos;")})'>Imprimir Fatura</button>

          <button class="btn-refresh" onclick="fecharFatura()">Fechar Fatura</button>
        </div>
      `;

          div.innerHTML = resumoHTML + tabela + botoes;
        })
        .catch(() => {
          div.innerHTML = "<p style='color:red;'>Erro ao consultar faturas.</p>";
        });
    }

    function fecharFatura() {
      const cliente = document.getElementById("fatCliente").value;
      const inicio = document.getElementById("fatInicio").value;
      const fim = document.getElementById("fatFim").value;

      if (!cliente || !inicio || !fim) {
        alert("Selecione cliente, data inicial e data final.");
        return;
      }
      if (!confirm("Confirmar fechamento da fatura deste período? As OS serão marcadas como faturadas.")) return;

      fetch("/fatura/fechar/", {
        method: "POST",
        headers: { "Content-Type": "application/json", "X-CSRFToken": getCSRFToken() },
        body: JSON.stringify({ cliente, inicio, fim })
      })
        .then(r => r.json())
        .then(data => {
          if (data.status === "sucesso") {
            alert(`Fatura fechada! OS afetadas: ${data.afetadas}`);
            consultarFatura();
            if (typeof atualizarTabelaOS === "function") atualizarTabelaOS();
          } else {
            alert("Erro ao fechar fatura: " + (data.erro || "desconhecido"));
          }
        })
        .catch(() => alert("Falha na requisição de fechamento."));
    }

    function imprimirNota(data) {
      // helpers locais
      const esc = (s) => (s == null ? "—" : String(s)
        .replace(/&/g, "&amp;").replace(/</g, "&lt;")
        .replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#39;"));
      const trunc = (s, n = 120) => {
        if (!s) return "—";
        const t = String(s).trim().replace(/\s+/g, " ");
        return t.length > n ? t.slice(0, n) + "…" : t;
      };
      const fmtBRL = (v) => {
        try { return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(+v || 0); }
        catch { const n = (+v || 0).toFixed(2).replace('.', ','); return `R$ ${n}`; }
      };
      const fmtData = (iso) => (typeof formatarDataBR === "function" ? formatarDataBR(iso) : (iso || "—"));
      const fmtDataHora = (iso) => (typeof formatarDataHoraBR === "function" ? formatarDataHoraBR(iso) : (iso || "—"));

      const osList = Array.isArray(data.os) ? data.os : [];
      const totalHoras = osList.reduce((s, it) => s + (+it.horas || 0), 0);
      const totalValor = osList.reduce((s, it) => s + (+it.total || 0), 0);

      // linhas compactas (5 colunas: ID, Descrição, Período, Horas, Total)
      const linhas = osList.map(it => {
        const desc = `
      <div><b>${esc(it.solicitante || "—")}</b></div>
      <div>${esc(trunc(it.problema, 140))}</div>
    `;
        const periodo = (it.inicio || it.fim)
          ? `<div><b>Início:</b> ${esc(fmtDataHora(it.inicio))}</div>
         <div><b>Fim:</b> ${esc(fmtDataHora(it.fim))}</div>`
          : `<div><b>Solicitado em:</b> ${esc(fmtData(it.data_solicitacao))}</div>`;
        return `
      <tr>
        <td class="num">${it.id}</td>
        <td class="wrap">${desc}</td>
        <td class="mono">${periodo}</td>
        <td class="num">${(+it.horas || 0).toFixed(2)}</td>
        <td class="num">${fmtBRL(+it.total || 0)}</td>
      </tr>
    `;
      }).join("");

      const win = window.open("", "_blank");
      win.document.write(`
    <html>
      <head>
        <meta charset="utf-8">
        <title>Fatura</title>
        <style>
          @page { size: A4 landscape; margin: 12mm; } /* <<< horizontal */
          * { box-sizing: border-box; }
          body { font-family: 'Segoe UI', Tahoma, sans-serif; color:#1f2937; margin:0; }
          h1 { font-size: 18px; margin: 0 0 6px; }
          .header { display:flex; align-items:center; gap:18px; margin-bottom:12px; }
          .header img { max-width: 110px; height:auto; }
          .empresa p { margin:2px 0; font-size: 12px; color:#374151; }

          .box { border:1px solid #e5e7eb; border-radius:8px; padding:10px 12px; margin-top:10px; }
          .box h3 { margin:0 0 6px; font-size: 14px; }

          table.compact { width:100%; border-collapse:collapse; margin-top:8px; }
          thead { display: table-header-group; }  /* repete cabeçalho em cada página */
          tfoot { display: table-footer-group; }
          th, td { border:1px solid #e5e7eb; padding:6px 8px; font-size:12px; vertical-align: top; }
          th { background:#f3f4f6; color:#374151; font-weight:600; }
          tbody tr:nth-child(odd) { background:#fafafa; }
          tr { page-break-inside: avoid; }

          td.num, th.num { text-align:right; font-variant-numeric: tabular-nums; white-space: nowrap; }
          td.mono, th.mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; font-size:11.5px; }
          td.wrap { white-space: normal; word-break: break-word; }

          /* Larguras pensadas para A4 horizontal (somam 100%) */
          col.col-id   { width: 7%; }
          col.col-desc { width: 49%; }
          col.col-per  { width: 18%; }
          col.col-hrs  { width: 10%; }
          col.col-tot  { width: 16%; }

          .totais-row th { background:#eef2ff; }
          .muted { color:#6b7280; }
        </style>
      </head>
      <body>
        <div class="header">
          <img src="${data.empresa.logo}" alt="Logo">
          <div class="empresa">

            <h1><b>${esc(data.empresa.nome)}</b></h1>
            <p class="muted">CNPJ: ${esc(data.empresa.cnpj)}</p>
          </div>
        </div>

        <div class="box">
          <h3>Dados do Cliente</h3>
          <p><b>Razão Social:</b> ${esc(data.cliente?.razao_social)}</p>
          <p><b>CPF/CNPJ:</b> ${esc(data.cliente?.cpf_cnpj)}</p>
          <p><b>Endereço:</b> ${esc(data.cliente?.endereco)}</p>
          <p><b>Período:</b> ${esc(fmtData(data.periodo.inicio))} a ${esc(fmtData(data.periodo.fim))}</p>
          <p><b>Status:</b> ${data.faturado === true ? "Fatura Fechada" :
          data.faturado === false ? "Fatura em Aberto" : "—"
        }</p>
        </div>

        <div class="box">
          <h3>Itens</h3>
          <table class="compact">
            <colgroup>
              <col class="col-id">
              <col class="col-desc">
              <col class="col-per">
              <col class="col-hrs">
              <col class="col-tot">
            </colgroup>
            <thead>
              <tr>
                <th class="num">ID</th>
                <th>Descrição</th>
                <th class="mono">Período</th>
                <th class="num">Horas</th>
                <th class="num">Total</th>
              </tr>
            </thead>
            <tbody>
              ${linhas}
            </tbody>
            <tfoot>
              <tr class="totais-row">
                <th colspan="3" class="num">Totais:</th>
                <th class="num">${totalHoras.toFixed(2)}</th>
                <th class="num">${fmtBRL(totalValor)}</th>
              </tr>
            </tfoot>
          </table>
        </div>

        <script>window.onload = function(){ window.print(); }<\/script>
      </body>
    </html>
  `);
      win.document.close();
    }



    function formatarDataBR(iso) {
      if (!iso) return "—";
      const [y, m, d] = iso.split("-");
      return `${d}/${m}/${y}`;
    }
    function formatarDataHoraBR(iso) {
      if (!iso) return "—";
      const dt = new Date(iso);
      if (isNaN(dt)) return "—";
      const dd = String(dt.getDate()).padStart(2, "0");
      const mm = String(dt.getMonth() + 1).padStart(2, "0");
      const yyyy = dt.getFullYear();
      const hh = String(dt.getHours()).padStart(2, "0");
      const mi = String(dt.getMinutes()).padStart(2, "0");
      return `${dd}/${mm}/${yyyy} ${hh}:${mi}`;
    }
    function safeBR(iso) { return iso ? formatarDataBR(iso) : "—"; }
    function safeBRdt(iso) { return iso ? formatarDataHoraBR(iso) : "—"; }

    function fecharFatura() {
      const cliente = document.getElementById("fatCliente").value;
      const inicio = document.getElementById("fatInicio").value;
      const fim = document.getElementById("fatFim").value;

      if (!cliente || !inicio || !fim) {
        alert("Selecione cliente, data inicial e data final.");
        return;
      }
      if (!confirm("Confirmar fechamento da fatura deste período? As OS serão marcadas como faturadas.")) return;

      fetch("/fatura/fechar/", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCSRFToken()
        },
        body: JSON.stringify({ cliente, inicio, fim })
      })
        .then(r => r.json())
        .then(data => {
          if (data.status === "sucesso") {
            alert(`Fatura fechada! OS afetadas: ${data.afetadas}`);
            consultarFatura();   // recarrega a tela de fatura
            atualizarTabelaOS?.(); // opcional: atualiza a lista de OS se a aba estiver aberta
          } else {
            alert("Erro ao fechar fatura: " + (data.erro || "desconhecido"));
          }
        })
        .catch(() => alert("Falha na requisição de fechamento."));
    }

  </script>
</body>

</html>
